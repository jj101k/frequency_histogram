<!DOCTYPE html>
<html>
    <head>

    </head>
    <body>
        <p>Import EPW data <input type="file" id="import"/></p>
        <script src="histogram.js"></script>
        <p>
            <svg id="gp" viewBox="0 0 1000 1000"
            xmlns="http://www.w3.org/2000/svg" style="width: 1000px">
                <path id="graph" d="" stroke="red" stroke-width="0.05" fill="none"></path>
            </svg>
        </p>
        <script>
            /** @type {HTMLInputElement} */
            const e = document.querySelector("#import")
            e.onchange = async function() {
                if(e.files) {
                    const fr = new FileReader()
                    fr.onload = () => {
                        if(typeof fr.result != "string") throw new Error("Wrong result type?")
                        // console.log(fr.result)
                        const trimmedResult = fr.result.split(/\nDATA PERIODS,.*\r\n/)[1]
                        let i = 0
                        const r = trimmedResult.replace(/\r?\n$/, "").split(/\r?\n/).map(
                            c => {
                                const f = c.split(/,/)
                                const t = +f[6]
                                if(Number.isNaN(t)) {
                                    throw new Error(`NaN on: ${c}`)
                                }
                                return {x: i++, y: t}
                            }
                        ) // .slice(0, 96)
                        console.log(r)
                        const h = new Histogram(r, 0.05)
                        console.log(h.deltas)
                        console.log(h.combinedDeltas)
                        console.log(h.cumulativeDeltas)

                        const cumulativeDeltas = h.cumulativeDeltas
                        let lastPos = {y: cumulativeDeltas[0].y - 0.1, fV: 0}
                        let dA = `M ${lastPos.y} ${lastPos.fV}`
                        let minX = cumulativeDeltas[0].y
                        let maxX = cumulativeDeltas[cumulativeDeltas.length - 1].y
                        let minY = 0
                        let maxY = -Infinity
                        for(const d of cumulativeDeltas) {
                            console.log(`${d.y} = ${Math.round(d.f)}`)
                            const v = -d.f / 50 // -Math.log(d.f)
                            const lA = `L ${d.y},${lastPos.fV} L ${d.y},${v}`
                            lastPos = {y: d.y, fV: v}
                            // console.log(lA)
                            dA += " " + lA
                            if(v > maxY) {
                                maxY = v
                            }
                            if(v < minY) {
                                minY = v
                            }
                        }

                        const box = `${minX} ${minY} ${maxX - minX} ${maxY - minY}`
                        console.log(box)
                        document.querySelector("#gp").setAttribute("viewBox", box)

                        document.querySelector("#graph").setAttribute("d", dA)
                    }
                    fr.readAsText(e.files[0])
                }
            }
        </script>
    </body>
</html>